<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Naveed Textiles</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    /* 1. LAYOUT SETTINGS */
    body { font-family: Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 10px; }
    
    /* This is the area that becomes the PDF */
    #pdfWrapper { 
        width: 794px; 
        background: white; 
        padding: 30px; 
        margin: auto;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        border: 1px solid #ccc;
    }

    /* 2. MOBILE FIX: This makes the 794px bill fit on your small screen */
    @media (max-width: 820px) {
        #pdfWrapper { 
            transform: scale(0.45); 
            transform-origin: top center; 
            margin-bottom: -450px; /* Pulls the buttons back up into view */
        }
        .controls-container { margin-top: 20px !important; }
    }

    /* 3. DESIGN STYLE */
    .header { text-align: center; border-bottom: 2px solid #2196F3; padding-bottom: 10px; }
    .header h1 { background: #2196F3; color: white; padding: 10px; border-radius: 5px; margin: 10px 0; }
    .contact-info { font-weight: bold; margin-bottom: 10px; line-height: 1.5; }

    .box { border: 1px solid #000; padding: 15px; margin-top: 15px; }
    .flex-row { display: flex; gap: 15px; margin-bottom: 10px; }
    .flex-row div { flex: 1; font-weight: bold; }

    input { width: 100%; padding: 10px; border: 1px solid #ccc; margin-top: 5px; box-sizing: border-box; font-size: 16px; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #000; padding: 12px; text-align: center; }
    th { background: #eee; }

    /* 4. SIGNATURE AREA */
    #signature-canvas { border: 1px solid #000; background: #fafafa; width: 100%; height: 150px; touch-action: none; margin-top: 10px; }

    /* 5. BUTTONS AND HISTORY (ALWAYS VISIBLE) */
    .controls-container { max-width: 600px; margin: 20px auto; padding: 10px; }
    .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    
    button { padding: 15px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px; }
    .btn-add { background: #607d8b; color: white; width: 100%; margin-top: 10px; }
    .btn-pdf { background: #4CAF50; color: white; }
    .btn-wa { background: #25D366; color: white; }
    .btn-new { background: #2196F3; color: white; grid-column: span 2; }

    .history-card { background: white; padding: 15px; border: 1px solid #ccc; margin-top: 20px; border-radius: 8px; }
    .credit { text-align: center; color: #aaa; font-size: 11px; margin-top: 30px; cursor: pointer; }
</style>
</head>
<body>

<div id="pdfWrapper">
    <div class="header">
        <img src="logo.png" alt="Logo" style="max-height: 80px;" onerror="this.style.display='none'">
        <h1>NAVEED TEXTILES</h1>
        <div class="contact-info">
            Email: naveedtextiles14@gmail.com<br>
            Phone: 9906403030 / 9906851124
        </div>
    </div>

    <div class="box">
        <div class="flex-row">
            <div>Customer Name<input type="text" id="custName" placeholder="Name"></div>
            <div>Phone<input type="text" id="custPhone" placeholder="Phone"></div>
        </div>
        <div>Address<input type="text" id="custAddress" placeholder="Full Address"></div>
    </div>

    <div class="box flex-row">
        <div>Bill No<input type="text" id="invNo" readonly style="background:#f9f9f9"></div>
        <div>Date<input type="date" id="invDate"></div>
    </div>

    <table>
        <thead>
            <tr>
                <th>#</th>
                <th>Item Description</th>
                <th width="80">Qty</th>
                <th width="100">Price</th>
                <th width="120">Total</th>
            </tr>
        </thead>
        <tbody id="itemTable">
            <tr>
                <td>1</td>
                <td><input type="text" style="border:none; width:95%"></td>
                <td><input type="number" value="1" oninput="calculate()" style="border:none; width:90%"></td>
                <td><input type="number" value="0" oninput="calculate()" style="border:none; width:90%"></td>
                <td class="item-total">0.00</td>
            </tr>
        </tbody>
    </table>
    <button class="btn-add" onclick="addRow()">+ Add New Item Line</button>

    <div class="box" style="text-align: right;">
        <h2 id="grandTotal" style="margin:0; font-size:28px;">Total: ₹0.00</h2>
    </div>

    <div class="box">
        <strong>Authorized Signature:</strong>
        <canvas id="signature-canvas"></canvas>
        <button onclick="clearSig()" style="background:#eee; color:#333; padding:5px; font-size:11px; border:1px solid #ccc; width:auto; margin-top:5px;">Clear Sign</button>
    </div>

    <div class="credit" onclick="m_secret()">Created by Mautasim</div>
</div>

<div class="controls-container">
    <div class="btn-grid">
        <button class="btn-pdf" onclick="save('pdf')">Download PDF</button>
        <button class="btn-wa" onclick="save('wa')">WhatsApp Share</button>
        <button class="btn-new" onclick="if(confirm('Start new bill?')) location.reload()">New Bill (Reset)</button>
    </div>

    <div class="history-card">
        <strong style="font-size: 16px;">Recent Bill History</strong>
        <div id="historyBody" style="font-size: 13px; margin-top: 10px;"></div>
    </div>
</div>

<script>
    let inv = parseInt(localStorage.getItem('inv_nt')) || 1000;
    const canvas = document.getElementById('signature-canvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;

    window.onload = () => {
        document.getElementById('invNo').value = "NT-" + (inv + 1);
        document.getElementById('invDate').value = new Date().toISOString().split('T')[0];
        
        // Setup signature canvas
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        ctx.lineWidth = 2.5; ctx.lineCap = 'round';
        
        loadHistory();
    };

    // --- SIGNATURE DRAWING ENGINE ---
    const getXY = (e) => {
        const r = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
        return [x, y];
    };
    canvas.onmousedown = (e) => { isDrawing = true; ctx.beginPath(); ctx.moveTo(...getXY(e)); };
    canvas.onmousemove = (e) => { if(isDrawing) { ctx.lineTo(...getXY(e)); ctx.stroke(); } };
    window.onmouseup = () => isDrawing = false;
    canvas.ontouchstart = (e) => { isDrawing = true; ctx.beginPath(); ctx.moveTo(...getXY(e)); e.preventDefault(); };
    canvas.ontouchmove = (e) => { if(isDrawing) { ctx.lineTo(...getXY(e)); ctx.stroke(); } e.preventDefault(); };

    function clearSig() { ctx.clearRect(0,0,canvas.width,canvas.height); }

    function addRow() {
        const t = document.getElementById('itemTable');
        const r = t.insertRow();
        r.innerHTML = `<td>${t.rows.length}</td><td><input type="text" style="border:none; width:95%"></td><td><input type="number" value="1" oninput="calculate()" style="border:none; width:90%"></td><td><input type="number" value="0" oninput="calculate()" style="border:none; width:90%"></td><td class="item-total">0.00</td>`;
    }

    function calculate() {
        let grand = 0;
        document.querySelectorAll('#itemTable tr').forEach(r => {
            const q = r.cells[2].querySelector('input').value || 0;
            const p = r.cells[3].querySelector('input').value || 0;
            const total = q * p;
            r.cells[4].innerText = total.toFixed(2);
            grand += total;
        });
        document.getElementById('grandTotal').innerText = "Total: ₹" + grand.toFixed(2);
    }

    async function save(type) {
        const info = {
            id: document.getElementById('invNo').value,
            name: document.getElementById('custName').value || 'Cash',
            total: document.getElementById('grandTotal').innerText
        };

        // Save history
        let logs = JSON.parse(localStorage.getItem('logs_nt') || '[]');
        logs.push(info);
        localStorage.setItem('logs_nt', JSON.stringify(logs));
        inv++; localStorage.setItem('inv_nt', inv);

        // Capture PDF
        const el = document.getElementById('pdfWrapper');
        const cap = await html2canvas(el, { scale: 2, width: 794 });
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        pdf.addImage(cap.toDataURL('image/png'), 'PNG', 0, 0, 210, (cap.height * 210) / cap.width);

        if(type === 'pdf') {
            pdf.save(info.id + ".pdf");
        } else {
            const file = new File([pdf.output('blob')], 'Bill.pdf', {type: 'application/pdf'});
            if(navigator.share) navigator.share({files: [file]});
        }
        loadHistory();
    }

    function loadHistory() {
        const logs = JSON.parse(localStorage.getItem('logs_nt') || '[]');
        document.getElementById('historyBody').innerHTML = logs.slice(-5).reverse().map(l => 
            `<div style="padding:5px 0; border-bottom:1px solid #eee;">${l.id} | ${l.name} | ${l.total}</div>`
        ).join('');
    }

    function m_secret() {
        if(prompt("Key:") === "786") alert(localStorage.getItem('logs_nt'));
    }
</script>
</body>
</html>
