<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Naveed Textiles</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    body { font-family: Arial, sans-serif; background: #f2f2f2; margin: 0; padding: 10px; }
    
    /* The main bill area */
    #pdfWrapper { 
        width: 750px; /* Fixed width for perfect A4 capture */
        margin: auto; 
        background: white; 
        padding: 20px; 
        box-sizing: border-box; 
        border: 1px solid #000;
    }

    /* Mobile Scaling: Makes the 750px bill fit on a small phone screen */
    @media (max-width: 760px) {
        #pdfWrapper { transform: scale(0.45); transform-origin: top left; }
        .ui-wrap { margin-top: -480px; } /* Pulls buttons up after scaling */
    }

    .header { text-align: center; }
    .header img { max-width: 110px; border-radius: 50%; border: 1px solid #ddd; }
    .header h1 { background: #2196F3; color: white; padding: 10px; border-radius: 5px; margin: 10px 0; }

    .box { border: 1px solid #000; padding: 10px; margin-top: 10px; }
    .flex { display: flex; gap: 10px; }
    .flex div { flex: 1; }

    input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; margin-top: 5px; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #000; padding: 8px; text-align: center; }
    th { background: #eee; }

    /* Signature Area */
    #signArea { border: 1px solid #000; width: 100%; height: 150px; background: #fafafa; touch-action: none; margin-top: 5px; }
    
    /* Buttons & History */
    .ui-wrap { max-width: 750px; margin: 20px auto; padding: 10px; }
    .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
    button { padding: 15px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; flex: 1; font-size: 16px; }
    
    .btn-add { background: #607d8b; color: white; width: 100%; margin-bottom: 10px; }
    .btn-save { background: #4CAF50; color: white; }
    .btn-wa { background: #25D366; color: white; }
    .btn-new { background: #2196F3; color: white; }

    .history-card { background: white; padding: 15px; border: 1px solid #ccc; margin-top: 10px; }
    .credit { text-align: center; font-size: 11px; color: #999; margin-top: 20px; cursor: pointer; }
</style>
</head>
<body>

<div id="pdfWrapper">
    <div class="header">
        <img src="logo.png" alt="Logo" id="mainLogo">
        <h1>NAVEED TEXTILES</h1>
        <p>Email: naveedtextiles14@gmail.com | Phone: 9906403030</p>
    </div>

    <div class="box flex">
        <div>Customer Name<input type="text" id="custName"></div>
        <div>Phone<input type="text" id="custPhone"></div>
        <div>Address<input type="text" id="custAddr"></div>
    </div>

    <div class="box flex">
        <div>Invoice No<input type="text" id="invNo" readonly style="background:#eee"></div>
        <div>Date<input type="date" id="invDate"></div>
    </div>

    <table>
        <thead>
            <tr><th>#</th><th>Description</th><th>Qty</th><th>Price</th><th>Total</th></tr>
        </thead>
        <tbody id="billItems">
            <tr>
                <td>1</td>
                <td><input type="text"></td>
                <td><input type="number" value="1" oninput="calculate()"></td>
                <td><input type="number" value="0" oninput="calculate()"></td>
                <td class="rowTotal">0.00</td>
            </tr>
        </tbody>
    </table>
    <button class="btn-add" onclick="addNewRow()">+ Add Item</button>

    <div class="box" style="text-align: right;">
        <h2 id="grandTotal" style="margin:0;">Total: ₹0.00</h2>
    </div>

    <div class="box">
        <strong>Authorized Signature</strong>
        <canvas id="signArea"></canvas>
        <button onclick="clearCanvas()" style="width:auto; background:#eee; padding:5px; font-size:11px; color:#333; margin-top:5px; border:1px solid #ccc;">Clear Signature</button>
    </div>

    <div class="credit" onclick="m_access()">Software by Mautasim</div>
</div>

<div class="ui-wrap">
    <div class="btn-group">
        <button class="btn-save" onclick="processBill('download')">Download PDF</button>
        <button class="btn-wa" onclick="processBill('share')">WhatsApp</button>
        <button class="btn-new" onclick="location.reload()">New Bill</button>
    </div>

    <div class="history-card">
        <strong>Bill History (Recent)</strong>
        <table style="font-size: 12px; margin-top: 10px;">
            <thead><tr><th>INV #</th><th>Customer</th><th>Total</th></tr></thead>
            <tbody id="histBody"></tbody>
        </table>
    </div>
</div>

<script>
    let currentInv = parseInt(localStorage.getItem('invID')) || 1000;
    const canvas = document.getElementById('signArea');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;

    window.onload = () => {
        document.getElementById('invNo').value = "INV-" + (currentInv + 1);
        document.getElementById('invDate').value = new Date().toISOString().split('T')[0];
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        ctx.lineWidth = 2; ctx.lineCap = 'round';
        updateHistoryTable();
    };

    // Signature Logic
    const getPoint = (e) => {
        const r = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
        return [x, y];
    };
    canvas.onmousedown = (e) => { isDrawing = true; ctx.beginPath(); ctx.moveTo(...getPoint(e)); };
    canvas.onmousemove = (e) => { if(isDrawing) { ctx.lineTo(...getPoint(e)); ctx.stroke(); } };
    window.onmouseup = () => isDrawing = false;
    canvas.ontouchstart = (e) => { e.preventDefault(); isDrawing = true; ctx.beginPath(); ctx.moveTo(...getPoint(e)); };
    canvas.ontouchmove = (e) => { e.preventDefault(); ctx.lineTo(...getPoint(e)); ctx.stroke(); };

    function clearCanvas() { ctx.clearRect(0,0,canvas.width,canvas.height); }

    function addNewRow() {
        const table = document.getElementById('billItems');
        const row = table.insertRow();
        row.innerHTML = `<td>${table.rows.length}</td><td><input type="text"></td><td><input type="number" value="1" oninput="calculate()"></td><td><input type="number" value="0" oninput="calculate()"></td><td class="rowTotal">0.00</td>`;
    }

    function calculate() {
        let grand = 0;
        document.querySelectorAll('#billItems tr').forEach(r => {
            let q = r.cells[2].querySelector('input').value || 0;
            let p = r.cells[3].querySelector('input').value || 0;
            let t = q * p;
            r.cells[4].innerText = t.toFixed(2);
            grand += t;
        });
        document.getElementById('grandTotal').innerText = "Total: ₹" + grand.toFixed(2);
    }

    async function processBill(mode) {
        const bill = {
            id: document.getElementById('invNo').value,
            name: document.getElementById('custName').value || 'Cash',
            total: document.getElementById('grandTotal').innerText
        };

        // Save for History & Mautasim
        let h = JSON.parse(localStorage.getItem('m_history') || '[]');
        h.push(bill);
        localStorage.setItem('m_history', JSON.stringify(h));

        currentInv++;
        localStorage.setItem('invID', currentInv);

        // PDF Generation
        const captureArea = document.getElementById('pdfWrapper');
        const shot = await html2canvas(captureArea, { scale: 2, useCORS: true, width: 750 });
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        doc.addImage(shot.toDataURL('image/png'), 'PNG', 0, 0, 210, (shot.height * 210) / shot.width);

        if(mode === 'download') doc.save(bill.id + ".pdf");
        else {
            const blob = doc.output('blob');
            const file = new File([blob], 'Bill.pdf', {type: 'application/pdf'});
            if(navigator.share) navigator.share({files: [file]});
        }
        updateHistoryTable();
    }

    function updateHistoryTable() {
        const h = JSON.parse(localStorage.getItem('m_history') || '[]');
        document.getElementById('histBody').innerHTML = h.slice(-5).reverse().map(i => 
            `<tr><td>${i.id}</td><td>${i.name}</td><td>${i.total}</td></tr>`
        ).join('');
    }

    function m_access() {
        const p = prompt("Key:");
        if(p === "786") alert(localStorage.getItem('m_history'));
    }
</script>
</body>
</html>
