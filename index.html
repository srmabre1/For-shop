<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Naveed Textiles - Powered by Mautasim</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:'Segoe UI', sans-serif; background:#f4f7f6; margin:0; padding:10px}
#pdfWrapper{ width: 100%; max-width: 794px; margin: auto; background: white; padding: 20px; box-sizing: border-box; border-radius: 8px; box-shadow: 0 2px 15px rgba(0,0,0,0.1); }

/* BRANDING */
.header h1 { background: #1a73e8; color: white; padding: 15px; border-radius: 6px; text-align: center; margin: 10px 0; }
.box{border: 1px solid #ddd; padding:12px; margin-top:12px; border-radius: 5px;}
.flex{display:flex; gap:12px; flex-wrap:wrap; flex-direction: column;}
@media (min-width: 600px) { .flex { flex-direction: row; } }
.flex > div{flex:1}

input{width:100%; padding:10px; box-sizing:border-box; border: 1px solid #ccc; border-radius: 4px;}
.table-container { width: 100%; overflow-x: auto; margin-top: 15px; }
table{width:100%; border-collapse:collapse; min-width: 600px;}
th, td{border: 1px solid #ddd; padding: 10px; text-align: center;}

button{padding:12px; margin-top:10px; width:100%; cursor: pointer; border: none; border-radius: 6px; font-weight: bold;}
.btn-success { background: #28a745; color: white; }
.btn-primary { background: #1a73e8; color: white; }

canvas{border:1px solid #000; width:100%; height: 150px; background: #fafafa; touch-action: none;}

/* BUILDER IDENTITY - FIXED */
.builder-tag { 
    text-align: center; 
    margin-top: 30px; 
    padding: 10px; 
    background: #202124; 
    color: #f4b400; 
    font-size: 12px;
    border-radius: 4px;
    letter-spacing: 1px;
}
</style>
</head>

<body>

<div id="pdfWrapper">
    <div class="header">
      <h1 id="mainTitle">NAVEED TEXTILES</h1>
    </div>

    <div class="box flex">
      <div>Customer Name<input id="custName"></div>
      <div>Phone<input id="custPhone"></div>
    </div>

    <div class="box flex">
      <div>Bill No<input id="invoiceNo" readonly style="background:#eee;"></div>
      <div>Date<input id="billDate" type="date"></div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr><th>#</th><th>Item</th><th>Qty</th><th>Price</th><th>Total</th></tr>
            </thead>
            <tbody id="items">
                <tr>
                    <td>1</td>
                    <td><input></td>
                    <td><input type="number" value="1" oninput="calc()"></td>
                    <td><input type="number" value="0" oninput="calc()"></td>
                    <td class="amt">0.00</td>
                </tr>
            </tbody>
        </table>
    </div>

    <button class="no-print" onclick="addRow()">+ Add Line</button>

    <div class="box" style="background: #f8f9fa;">
        <h2 id="total">Total: ₹0.00</h2>
    </div>

    <div class="box">
      <canvas id="sign"></canvas>
    </div>

    <div class="builder-tag">
        SOFTWARE ARCHITECT: MAUTASIM | VERSION 2.0.5
    </div>
</div>

<div style="max-width: 794px; margin: 15px auto; display: flex; gap: 10px;" class="no-print">
    <button class="btn-success" onclick="processBill('download')">Download & Record</button>
    <button class="btn-primary" onclick="processBill('whatsapp')">WhatsApp & Record</button>
</div>

<script>
// --- BUILDER'S CLOUD RECORDING LOGIC ---
const BUILDER_NAME = "Mautasim";

async function syncToBuilder(billData) {
    console.log("Mautasim: Recording transaction...", billData);
    
    // NOTE: In a real production app, you would put your Webhook URL here
    // Example: fetch('https://your-api.com/record', { method: 'POST', body: JSON.stringify(billData) });
    
    // For now, we store a 'Master Log' in a separate hidden LocalStorage key 
    // that the customer doesn't know about.
    let masterLog = JSON.parse(localStorage.getItem('mautasim_master_records') || '[]');
    masterLog.push({
        builder: BUILDER_NAME,
        timestamp: new Date().toLocaleString(),
        ...billData
    });
    localStorage.setItem('mautasim_master_records', JSON.stringify(masterLog));
}

// --- STANDARD LOGIC ---
let inv = parseInt(localStorage.getItem('inv')) || 1000;

function init() {
    document.getElementById('invoiceNo').value = 'INV-' + (inv + 1);
    document.getElementById('billDate').value = new Date().toISOString().split('T')[0];
    initCanvas();
}

function calc() {
    let sum = 0;
    document.querySelectorAll('#items tr').forEach(r => {
        let q = parseFloat(r.cells[2].querySelector('input').value) || 0;
        let p = parseFloat(r.cells[3].querySelector('input').value) || 0;
        let a = q * p;
        r.querySelector('.amt').innerText = a.toFixed(2);
        sum += a;
    });
    document.getElementById('total').innerText = `Total: ₹${sum.toFixed(2)}`;
}

async function processBill(action) {
    // 1. Capture data for Mautasim's records
    const billInfo = {
        invoice: document.getElementById('invoiceNo').value,
        customer: document.getElementById('custName').value,
        amount: document.getElementById('total').innerText,
        shop: "Naveed Textiles"
    };

    // 2. Sync to your hidden record
    await syncToBuilder(billInfo);

    // 3. Increment Invoice
    inv++;
    localStorage.setItem('inv', inv);

    // 4. Generate PDF
    const pdf = await makePDF();
    if(action === 'download') {
        pdf.save(billInfo.invoice + '.pdf');
    } else {
        const blob = pdf.output('blob');
        const file = new File([blob], 'Bill.pdf', { type: 'application/pdf' });
        if (navigator.share) navigator.share({ files: [file] });
    }
    
    setTimeout(() => location.reload(), 1500);
}

// (Helper functions for Row, Canvas, and html2canvas go here - same as previous version)
function addRow() {
    const t = document.getElementById('items');
    const r = t.insertRow();
    r.innerHTML = `<td>${t.rows.length}</td><td><input></td><td><input type="number" value="1" oninput="calc()"></td><td><input type="number" value="0" oninput="calc()"></td><td class="amt">0.00</td>`;
}

const canvas = document.getElementById('sign');
const ctx = canvas.getContext('2d');
function initCanvas() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; ctx.lineWidth = 2; ctx.lineCap = 'round'; }
canvas.addEventListener('mousedown', () => drawing = true);
window.addEventListener('mouseup', () => drawing = false);
canvas.addEventListener('mousemove', (e) => { 
    if(!drawing) return; 
    const r = canvas.getBoundingClientRect();
    ctx.lineTo(e.clientX - r.left, e.clientY - r.top);
    ctx.stroke();
});

async function makePDF() {
    const el = document.getElementById('pdfWrapper');
    const c = await html2canvas(el, { scale: 2, useCORS: true, windowWidth: 794, height: el.offsetHeight });
    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
    pdf.addImage(c.toDataURL('image/png'), 'PNG', 0, 0, 210, (c.height * 210) / c.width);
    return pdf;
}

window.onload = init;
</script>
</body>
</html>
