<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Shop Billing</title>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5189047543441783"
     crossorigin="anonymous"></script>
<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial;background:#f2f2f2;margin:0;padding:10px}
#pdfWrapper{
  width: 100%;
  max-width: 794px;   /* desktop & PDF only */
  margin: auto;
  background: white;
  padding: 8px;
}

/* ONLY for PDF / print */
@media print{
  #pdfWrapper{
    width: 794px;
  }
}

.header{text-align:center}
.header img{max-width:120px}
.box{border:1px solid #000;padding:8px;margin-top:8px}
.flex{display:flex;gap:10px;flex-wrap:wrap}
.flex > div{flex:1}
input{width:100%;padding:6px;box-sizing:border-box}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #000;padding:6px;text-align:center}
button{padding:8px;margin-top:10px;width:100%}
canvas{border:1px solid #000;width:100%;height:150px;touch-action:none}
.footer{text-align:center;margin-top:10px;font-size:12px}
@media print{body{background:#fff}}
  @media print {
  button { display: none !important; } /* Hides buttons on the PDF */
  input { border: none !important; }  /* Removes input boxes for a cleaner look */
}

</style>
</head>

<body>

<div id="pdfWrapper">

<div class="header">
  <img src="logo.png" alt="Logo">
  <h2>NAVEED TEXTILES</h2>
</div>

<div class="box">
Email: naveedtextiles14@gmail.com<br>
Phone: 9906403030 / 9906851124
</div>

<!-- Part A: Customer -->
<div class="box flex">
  <div>Customer Name<input id="custName"></div>
  <div>Customer Phone<input id="custPhone"></div>
  <div>customer address<input id="custaddress"></div>
</div>

<div class="box flex">
  <div>Bill No<input id="invoiceNo" readonly></div>
  <div>ðŸ“… Date<input id="billDate" readonly></div>
</div>

<table>
<thead>
<tr><th>#</th><th>Item</th><th>Qty</th><th>Price</th><th>Amount</th></tr>
</thead>
<tbody id="items">
<tr>
<td>1</td>
<td><input></td>
<td><input type="number" oninput="calc()"></td>
<td><input type="number" oninput="calc()"></td>
<td class="amt">0</td>
</tr>
</tbody>
</table>

<button onclick="addRow()">Add Item</button>

<!-- Part B: GST -->
<div class="box flex">
  <div>Discount %<input id="disc" type="number" value="0" oninput="calc()"></div>
  <div>GST %<input id="gst" type="number" value="0" oninput="calc()"></div>
</div>

<div class="box flex">
  <div>Paid â‚¹<input id="paid" type="number" value="0" oninput="calc()"></div>
</div>

<h3 id="total">Total: â‚¹0</h3>
<h3 id="balance">Balance: â‚¹0</h3>

<div class="box">
<h3>Authorized Signature</h3>
<canvas id="sign"></canvas>
<button onclick="clearSign()">Clear Signature</button>
</div>

<div class="footer">Web built by Mautasim</div>
</div>

<button onclick="downloadPDF()">Download PDF</button>
<button onclick="whatsappPDF()">WhatsApp PDF</button>
<script>// --- 1. Initialization ---
let inv = parseInt(localStorage.getItem('inv')) || 1000;
document.getElementById('invoiceNo').value = 'INV-' + (inv + 1);
document.getElementById('billDate').value = new Date().toISOString().split('T')[0];
loadHistory();

// --- 2. Core Logic ---
function addRow(item = '', qty = '', price = '', amt = '0.00') {
    const t = document.getElementById('items');
    const r = t.insertRow();
    r.innerHTML = `
        <td>${t.rows.length}</td>
        <td><input value="${item}"></td>
        <td><input type="number" value="${qty}" oninput="calc()"></td>
        <td><input type="number" value="${price}" oninput="calc()"></td>
        <td class="amt">${amt}</td>`;
}

function calc() {
    let sum = 0;
    document.querySelectorAll('#items tr').forEach(r => {
        let q = r.cells[2].querySelector('input').value || 0;
        let p = r.cells[3].querySelector('input').value || 0;
        let a = q * p;
        r.querySelector('.amt').innerText = a.toFixed(2);
        sum += a;
    });
    let d = sum * (document.getElementById('disc').value || 0) / 100;
    let g = (sum - d) * (document.getElementById('gst').value || 0) / 100;
    let total = sum - d + g;
    document.getElementById('total').innerText = `Total: â‚¹${total.toFixed(2)}`;
    document.getElementById('balance').innerText = 'Balance: â‚¹' + (total - (document.getElementById('paid').value || 0)).toFixed(2);
}

// --- 3. Save & History Logic ---
function saveBill() {
    const billId = document.getElementById('invoiceNo').value;
    const items = [];
    document.querySelectorAll('#items tr').forEach(r => {
        items.push({
            name: r.cells[1].querySelector('input').value,
            qty: r.cells[2].querySelector('input').value,
            price: r.cells[3].querySelector('input').value
        });
    });

    const billData = {
        id: billId,
        date: document.getElementById('billDate').value,
        name: document.getElementById('custName').value,
        phone: document.getElementById('custPhone').value,
        address: document.getElementById('custaddress').value,
        items: items,
        disc: document.getElementById('disc').value,
        gst: document.getElementById('gst').value,
        paid: document.getElementById('paid').value,
        total: document.getElementById('total').innerText
    };

    let history = JSON.parse(localStorage.getItem('billHistory') || '[]');
    // Check if we are updating an existing bill or adding a new one
    const index = history.findIndex(b => b.id === billId);
    if (index > -1) {
        history[index] = billData;
    } else {
        history.push(billData);
        localStorage.setItem('inv', inv + 1); // Only increment if it's a new bill
    }
    
    localStorage.setItem('billHistory', JSON.stringify(history));
    loadHistory();
}

function loadHistory() {
    const history = JSON.parse(localStorage.getItem('billHistory') || '[]');
    const body = document.getElementById('historyBody');
    body.innerHTML = '';
    history.reverse().forEach(bill => {
        const row = body.insertRow();
        row.innerHTML = `
            <td>${bill.id}</td>
            <td>${bill.date}</td>
            <td>${bill.name}</td>
            <td>${bill.total}</td>
            <td><button onclick="editBill('${bill.id}')" style="background:orange; color:white; width:auto; padding:4px 8px;">Edit</button></td>
        `;
    });
}

function editBill(id) {
    const history = JSON.parse(localStorage.getItem('billHistory') || '[]');
    const bill = history.find(b => b.id === id);
    if (!bill) return;

    // Fill fields
    document.getElementById('invoiceNo').value = bill.id;
    document.getElementById('billDate').value = bill.date;
    document.getElementById('custName').value = bill.name;
    document.getElementById('custPhone').value = bill.phone;
    document.getElementById('custaddress').value = bill.address;
    document.getElementById('disc').value = bill.disc;
    document.getElementById('gst').value = bill.gst;
    document.getElementById('paid').value = bill.paid;

    // Clear and refill items
    const table = document.getElementById('items');
    table.innerHTML = '';
    bill.items.forEach(item => addRow(item.name, item.qty, item.price));
    calc();
    window.scrollTo(0,0);
}

// --- 4. Signature & PDF (Updated to trigger Save) ---
// ... (Keep your existing Signature Canvas code here) ...

async function downloadPDF() { 
    saveBill(); // Auto-save when downloading
    const pdf = await makePDF(); 
    pdf.save(`${document.getElementById('invoiceNo').value}.pdf`); 
}
</script>

<hr>
<div id="historySection" style="max-width: 794px; margin: 20px auto; background: white; padding: 10px; border: 1px solid #ccc;">
    <h3>Bill History</h3>
    <table id="historyTable">
        <thead>
            <tr>
                <th>Bill No</th>
                <th>Date</th>
                <th>Customer</th>
                <th>Total</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="historyBody"></tbody>
    </table>
</div>

</body>
</html>

