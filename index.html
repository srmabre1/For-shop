<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Naveed Textiles - Professional</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding: 10px; }
    #billFrame { width: 100%; max-width: 600px; margin: auto; background: white; padding: 20px; box-sizing: border-box; border: 1px solid #ddd; }
    
    .header-blue { background: #1a73e8; color: white; text-align: center; padding: 15px; border-radius: 5px; margin-bottom: 15px; }
    .header-blue h1 { margin: 0; font-size: 22px; text-transform: uppercase; letter-spacing: 1px; }

    .input-box { border: 1px solid #000; padding: 10px; margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 10px; }
    .input-box div { flex: 1; min-width: 120px; font-size: 13px; font-weight: bold; }
    input { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; box-sizing: border-box; }

    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    th, td { border: 1px solid #000; padding: 8px; text-align: center; font-size: 13px; }
    th { background: #eee; }

    #sigArea { border: 1px solid #000; width: 100%; height: 120px; background: #fafafa; margin-top: 5px; touch-action: none; }
    
    .total-box { border: 2px solid #000; padding: 10px; text-align: right; background: #fff; margin-top: 10px; }
    .total-box h2 { margin: 0; color: #d93025; }

    .no-print { max-width: 600px; margin: 20px auto; display: flex; gap: 8px; flex-wrap: wrap; }
    button { padding: 12px; flex: 1; cursor: pointer; font-weight: bold; border-radius: 4px; border: none; font-size: 14px; }
    .btn-add { background: #5f6368; color: white; width: 100%; margin-bottom: 10px; }
    .btn-pdf { background: #28a745; color: white; }
    .btn-wa { background: #25D366; color: white; }
    .btn-new { background: #1a73e8; color: white; }

    .footer-tag { text-align: center; margin-top: 20px; font-size: 11px; color: #999; border-top: 1px solid #eee; padding-top: 10px; cursor: pointer; }
</style>
</head>
<body>

<div id="billFrame">
    <div class="header-blue">
        <h1>NAVEED TEXTILES</h1>
        <div style="font-size: 12px; margin-top: 5px;">naveedtextiles14@gmail.com | 9906403030</div>
    </div>

    <div class="input-box">
        <div>Customer Name<input id="cName"></div>
        <div>Phone<input id="cPhone"></div>
    </div>

    <div class="input-box">
        <div>Bill No<input id="invNo" readonly style="background:#f9f9f9"></div>
        <div>Date<input id="bDate" type="date"></div>
    </div>

    <table>
        <thead>
            <tr><th>#</th><th>Item</th><th>Qty</th><th>Price</th><th>Total</th></tr>
        </thead>
        <tbody id="billItems">
            <tr>
                <td>1</td>
                <td><input></td>
                <td><input type="number" value="1" oninput="doMath()"></td>
                <td><input type="number" value="0" oninput="doMath()"></td>
                <td class="rowTotal">0.00</td>
            </tr>
        </tbody>
    </table>
    <button class="btn-add no-print" onclick="addNewRow()">+ Add Item Row</button>

    <div class="total-box">
        <h2 id="finalTotal">Total: ₹0.00</h2>
    </div>

    <div style="margin-top: 15px;">
        <span style="font-size: 12px; font-weight: bold;">Authorized Signature:</span>
        <canvas id="sigArea"></canvas>
        <button class="no-print" style="width: auto; padding: 4px 8px; font-size: 10px; background: #eee;" onclick="clearSig()">Clear Sign</button>
    </div>

    <div class="footer-tag" onclick="builderAccess()">
        Software Managed by Mautasim
    </div>
</div>

<div class="no-print">
    <button class="btn-pdf" onclick="saveAndGo('pdf')">Download PDF</button>
    <button class="btn-wa" onclick="saveAndGo('wa')">WhatsApp</button>
    <button class="btn-new" onclick="location.reload()">New Bill</button>
</div>

<script>
    let currentInv = parseInt(localStorage.getItem('invNum')) || 1000;
    const canvas = document.getElementById('sigArea');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;

    window.onload = () => {
        document.getElementById('invNo').value = "INV-" + (currentInv + 1);
        document.getElementById('bDate').value = new Date().toISOString().split('T')[0];
        setupCanvas();
    };

    function setupCanvas() {
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        
        const getXY = (e) => {
            const r = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return [clientX - r.left, clientY - r.top];
        };

        const start = (e) => { isDrawing = true; ctx.beginPath(); const [x,y] = getXY(e); ctx.moveTo(x,y); };
        const move = (e) => { if(!isDrawing) return; e.preventDefault(); const [x,y] = getXY(e); ctx.lineTo(x,y); ctx.stroke(); };
        const stop = () => isDrawing = false;

        canvas.onmousedown = start; canvas.onmousemove = move; window.onmouseup = stop;
        canvas.ontouchstart = start; canvas.ontouchmove = move; window.ontouchend = stop;
    }

    function clearSig() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

    function addNewRow() {
        const table = document.getElementById('billItems');
        const r = table.insertRow();
        r.innerHTML = `<td>${table.rows.length}</td><td><input></td><td><input type="number" value="1" oninput="doMath()"></td><td><input type="number" value="0" oninput="doMath()"></td><td class="rowTotal">0.00</td>`;
    }

    function doMath() {
        let grand = 0;
        document.querySelectorAll('#billItems tr').forEach(row => {
            const q = row.cells[2].querySelector('input').value || 0;
            const p = row.cells[3].querySelector('input').value || 0;
            const t = q * p;
            row.cells[4].innerText = t.toFixed(2);
            grand += t;
        });
        document.getElementById('finalTotal').innerText = "Total: ₹" + grand.toFixed(2);
    }

    async function saveAndGo(type) {
        // Record keeping for Mautasim
        const bill = {
            id: document.getElementById('invNo').value,
            client: document.getElementById('cName').value,
            amt: document.getElementById('finalTotal').innerText,
            time: new Date().toLocaleString()
        };
        
        let logs = JSON.parse(localStorage.getItem('m_logs') || '[]');
        logs.push(bill);
        localStorage.setItem('m_logs', JSON.stringify(logs));

        currentInv++;
        localStorage.setItem('invNum', currentInv);

        const frame = document.getElementById('billFrame');
        const canvasImage = await html2canvas(frame, { scale: 2 });
        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
        pdf.addImage(canvasImage.toDataURL('image/png'), 'PNG', 0, 0, 210, (canvasImage.height * 210) / canvasImage.width);

        if(type === 'pdf') pdf.save(bill.id + ".pdf");
        else {
            const blob = pdf.output('blob');
            const file = new File([blob], 'Bill.pdf', {type: 'application/pdf'});
            if(navigator.share) navigator.share({files: [file]});
        }
    }

    function builderAccess() {
        const pin = prompt("Enter Builder Key:");
        if(pin === "786") {
            const data = localStorage.getItem('m_logs');
            alert(data ? data : "No records yet.");
        }
    }
</script>
</body>
</html>
