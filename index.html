<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Naveed Textiles - Billing</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    body { font-family: sans-serif; background: #f4f7f6; margin: 0; padding: 10px; }
    
    #pdfArea { 
        width: 794px; 
        background: white; 
        padding: 30px; 
        margin: auto; 
        border: 1px solid #000;
        box-sizing: border-box;
    }

    @media (max-width: 820px) {
        #pdfArea { transform: scale(0.45); transform-origin: top center; margin-bottom: -480px; }
    }

    .header { text-align: center; border-bottom: 2px solid #2196F3; margin-bottom: 15px; }
    .header h1 { background: #2196F3; color: white; padding: 10px; margin: 10px 0; border-radius: 4px; font-size: 32px; }
    .header p { font-weight: bold; margin: 5px 0; font-size: 16px; }

    .box { border: 1px solid #000; padding: 12px; margin-top: 10px; }
    .flex { display: flex; gap: 10px; }
    .flex div { flex: 1; font-weight: bold; font-size: 13px; }

    input { width: 100%; padding: 8px; border: 1px solid #ccc; margin-top: 4px; box-sizing: border-box; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #000; padding: 10px; text-align: center; font-size: 14px; }
    th { background: #f2f2f2; }

    .calc-box { margin-top: 15px; width: 300px; margin-left: auto; }
    .calc-row { display: flex; justify-content: space-between; padding: 5px 0; font-weight: bold; border-bottom: 1px solid #eee; }

    #sig-canvas { border: 1px solid #000; width: 100%; height: 140px; margin-top: 5px; touch-action: none; background: #fafafa; }

    .ui-wrap { max-width: 600px; margin: 20px auto; display: flex; flex-direction: column; gap: 10px; }
    .btn { padding: 15px; border: none; border-radius: 5px; font-weight: bold; color: white; cursor: pointer; font-size: 16px; }
    .btn-pdf { background: #4CAF50; }
    .btn-wa { background: #25D366; }
    .btn-reset { background: #2196F3; }
    .btn-add { background: #607d8b; width: 100%; margin-top: 10px; padding: 10px; }

    .history { background: white; padding: 15px; border: 1px solid #ccc; margin-top: 20px; }
</style>
</head>
<body>

<div id="pdfArea">
    <div class="header">
        <h1>NAVEED TEXTILES</h1>
        <p>Email: naveedtextiles14@gmail.com</p>
        <p>Phone: 9906403030 / 9906851124</p>
    </div>

    <div class="box flex">
        <div>Name<input id="cN"></div>
        <div>Phone<input id="cP"></div>
        <div>Address<input id="cA"></div>
    </div>

    <div class="box flex">
        <div>Invoice #<input id="iN" readonly style="background:#eee"></div>
        <div>Date<input id="iD" type="date"></div>
    </div>

    <table>
        <thead>
            <tr><th>#</th><th>Item</th><th>Qty</th><th>Rate</th><th>Total</th></tr>
        </thead>
        <tbody id="items">
            <tr>
                <td>1</td>
                <td><input type="text"></td>
                <td><input type="number" value="1" oninput="calc()"></td>
                <td><input type="number" value="0" oninput="calc()"></td>
                <td class="row-total">0.00</td>
            </tr>
        </tbody>
    </table>
    <button class="btn btn-add" onclick="addRow()">+ Add New Row</button>

    <div class="calc-box">
        <div class="calc-row"><span>Sub Total:</span><span id="subT">0.00</span></div>
        <div class="calc-row"><span>Discount (₹):</span><span><input id="disc" type="number" value="0" oninput="calc()" style="width:80px; margin:0; padding:2px;"></span></div>
        <div class="calc-row" style="background:#2196F3; color:white; padding:8px 5px;"><span>Net Payable:</span><span id="netT">₹0.00</span></div>
    </div>

    <div class="box">
        <strong>Signature:</strong>
        <canvas id="sig-canvas"></canvas>
        <button onclick="clearS()" style="font-size:10px; padding:2px 5px; margin-top:5px;">Clear Sign</button>
    </div>
</div>

<div class="ui-wrap">
    <button class="btn btn-pdf" onclick="save('pdf')">Download PDF</button>
    <button class="btn btn-wa" onclick="save('share')">Send to WhatsApp</button>
    <button class="btn btn-reset" onclick="location.reload()">New Invoice</button>

    <div class="history">
        <strong>Recent History:</strong>
        <div id="hList" style="font-size:12px; margin-top:10px;"></div>
    </div>
</div>

<script>
    let inv = parseInt(localStorage.getItem('nt_inv_id')) || 1000;
    const canvas = document.getElementById('sig-canvas');
    const ctx = canvas.getContext('2d');
    let draw = false;

    window.onload = () => {
        document.getElementById('iN').value = "NT-" + (inv + 1);
        document.getElementById('iD').value = new Date().toISOString().split('T')[0];
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        ctx.lineWidth = 2; ctx.lineCap = 'round';
        showH();
    };

    // Signature Logic
    const getXY = (e) => {
        const r = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
        return [x, y];
    };
    canvas.onmousedown = (e) => { draw = true; ctx.beginPath(); ctx.moveTo(...getXY(e)); };
    canvas.onmousemove = (e) => { if(draw) { ctx.lineTo(...getXY(e)); ctx.stroke(); } };
    window.onmouseup = () => draw = false;
    canvas.ontouchstart = (e) => { e.preventDefault(); draw = true; ctx.beginPath(); ctx.moveTo(...getXY(e)); };
    canvas.ontouchmove = (e) => { e.preventDefault(); ctx.lineTo(...getXY(e)); ctx.stroke(); };

    function clearS() { ctx.clearRect(0,0,canvas.width,canvas.height); }

    function addRow() {
        const t = document.getElementById('items');
        const r = t.insertRow();
        r.innerHTML = `<td>${t.rows.length}</td><td><input type="text"></td><td><input type="number" value="1" oninput="calc()"></td><td><input type="number" value="0" oninput="calc()"></td><td class="row-total">0.00</td>`;
    }

    function calc() {
        let sub = 0;
        document.querySelectorAll('#items tr').forEach(r => {
            let q = r.cells[2].querySelector('input').value || 0;
            let p = r.cells[3].querySelector('input').value || 0;
            let amt = q * p;
            r.cells[4].innerText = amt.toFixed(2);
            sub += amt;
        });
        let d = document.getElementById('disc').value || 0;
        document.getElementById('subT').innerText = sub.toFixed(2);
        document.getElementById('netT').innerText = "₹" + (sub - d).toFixed(2);
    }

    async function save(mode) {
        const bill = {
            id: document.getElementById('iN').value,
            name: document.getElementById('cN').value || 'Cash',
            total: document.getElementById('netT').innerText
        };

        let logs = JSON.parse(localStorage.getItem('nt_logs') || '[]');
        logs.push(bill);
        localStorage.setItem('nt_logs', JSON.stringify(logs));
        inv++; localStorage.setItem('nt_inv_id', inv);

        const area = document.getElementById('pdfArea');
        const shot = await html2canvas(area, { scale: 2, width: 794 });
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        pdf.addImage(shot.toDataURL('image/png'), 'PNG', 0, 0, 210, (shot.height * 210) / shot.width);

        if(mode === 'pdf') pdf.save(bill.id + ".pdf");
        else {
            const file = new File([pdf.output('blob')], 'Bill.pdf', {type:'application/pdf'});
            if(navigator.share) navigator.share({files:[file]});
        }
        showH();
    }

    function showH() {
        let logs = JSON.parse(localStorage.getItem('nt_logs') || '[]');
        document.getElementById('hList').innerHTML = logs.slice(-5).reverse().map(l => 
            `<div style="padding:4px; border-bottom:1px solid #eee;">${l.id} | ${l.name} | ${l.total}</div>`
        ).join('');
    }
</script>
</body>
</html>
