<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Naveed Textiles</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Arial, sans-serif;background:#f2f2f2;margin:0;padding:10px}
/* Fixed width for PDF capture to prevent cutting off */
#pdfWrapper{width:794px;margin:auto;background:white;padding:15px;box-sizing:border-box;box-shadow:0 0 10px rgba(0,0,0,0.1)}

/* Responsive view for your phone screen */
@media (max-width: 800px) {
    #pdfWrapper { transform: scale(0.48); transform-origin: top left; margin-bottom: -450px; }
}

.header{text-align:center}
.header img{max-width:110px;border-radius:50%}
.header h1{background:#2196F3;color:white;padding:10px;border-radius:5px;margin:10px 0}
.box{border:1px solid #000;padding:10px;margin-top:10px}
.flex{display:flex;gap:10px;flex-wrap:wrap}
.flex > div{flex:1; min-width: 150px;}
input{width:100%;padding:8px;box-sizing:border-box;border:1px solid #ccc;margin-top:5px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #000;padding:8px;text-align:center}

/* UI Controls */
.controls { max-width: 794px; margin: 20px auto; display: flex; gap: 10px; }
button{padding:12px;cursor:pointer;border:none;border-radius:4px;font-weight:bold;flex:1}
.btn-add{background:#607d8b;color:white;width:100%;margin-top:10px}
.btn-download{background:#4CAF50;color:white}
.btn-whatsapp{background:#25D366;color:white}
.btn-new{background:#2196F3;color:white}

canvas{border:1px solid #000;width:100%;height:160px;touch-action:none;background:#fafafa;margin-top:5px}
.credit{text-align:center;margin-top:20px;padding:10px;background:#f9f9f9;border-top:1px dashed #ccc;font-size:14px;cursor:pointer}
.no-print{display:block}
</style>
</head>
<body>

<div id="pdfWrapper">
    <div class="header">
      <img src="logo.png" alt="Logo" onerror="this.style.display='none'">
      <h1>NAVEED TEXTILES</h1>
    </div>

    <div class="box">
      <strong>Email:</strong> naveedtextiles14@gmail.com<br>
      <strong>Phone:</strong> 9906403030 / 9906851124
    </div>

    <div class="box flex">
      <div>Customer Name<input id="custName" type="text"></div>
      <div>Phone<input id="custPhone" type="text"></div>
      <div>Address<input id="custAddress" type="text"></div>
    </div>

    <div class="box flex">
      <div>Bill No<input id="invoiceNo" readonly style="background:#eee"></div>
      <div>Date<input id="billDate" type="date"></div>
    </div>

    <table>
        <thead>
            <tr style="background:#eee"><th>#</th><th>Item Description</th><th>Qty</th><th>Price</th><th>Amount</th></tr>
        </thead>
        <tbody id="items">
            <tr>
                <td>1</td>
                <td><input type="text" placeholder="Item Name"></td>
                <td><input type="number" value="1" oninput="calc()"></td>
                <td><input type="number" value="0" oninput="calc()"></td>
                <td class="amt">0.00</td>
            </tr>
        </tbody>
    </table>
    <button class="btn-add no-print" onclick="addRow()">+ Add New Item Row</button>

    <div class="box" style="text-align:right">
        <h2 id="totalDisplay" style="margin:0">Total: ₹0.00</h2>
    </div>

    <div class="box">
      <h3 style="margin-top:0">Signature</h3>
      <canvas id="sign"></canvas>
      <button class="no-print" style="background:#eee;color:#333;width:auto;padding:5px;font-size:11px" onclick="clearSign()">Clear Signature</button>
    </div>

    <div class="credit" onclick="mautasimSecret()">
        Web built by <strong>Mautasim</strong>
    </div>
</div>

<div class="controls no-print">
    <button class="btn-download" onclick="generateBill('download')">Download PDF</button>
    <button class="btn-whatsapp" onclick="generateBill('whatsapp')">Send WhatsApp</button>
    <button class="btn-new" onclick="location.reload()">New Bill</button>
</div>

<script>
let inv = parseInt(localStorage.getItem('inv')) || 1000;
const canvas = document.getElementById('sign');
const ctx = canvas.getContext('2d');
let drawing = false;

window.onload = () => {
    document.getElementById('invoiceNo').value = 'INV-' + (inv + 1);
    document.getElementById('billDate').value = new Date().toISOString().split('T')[0];
    setupCanvas();
};

function setupCanvas() {
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#000';
}

function getPos(e) {
    const r = canvas.getBoundingClientRect();
    const cx = e.touches ? e.touches[0].clientX : e.clientX;
    const cy = e.touches ? e.touches[0].clientY : e.clientY;
    return [cx - r.left, cy - r.top];
}

canvas.addEventListener('mousedown', (e) => { drawing = true; ctx.beginPath(); ctx.moveTo(...getPos(e)); });
canvas.addEventListener('mousemove', (e) => { if(drawing) { ctx.lineTo(...getXY(e)); ctx.stroke(); } });
window.addEventListener('mouseup', () => drawing = false);

canvas.addEventListener('touchstart', (e) => { 
    drawing = true; ctx.beginPath(); ctx.moveTo(...getPos(e)); e.preventDefault(); 
}, {passive: false});
canvas.addEventListener('touchmove', (e) => { 
    if(drawing) { ctx.lineTo(...getPos(e)); ctx.stroke(); } e.preventDefault(); 
}, {passive: false});
canvas.addEventListener('touchend', () => drawing = false);

function clearSign() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

function addRow() {
    const t = document.getElementById('items');
    const r = t.insertRow();
    r.innerHTML = `<td>${t.rows.length}</td><td><input type="text"></td><td><input type="number" value="1" oninput="calc()"></td><td><input type="number" value="0" oninput="calc()"></td><td class="amt">0.00</td>`;
}

function calc() {
    let sum = 0;
    document.querySelectorAll('#items tr').forEach(r => {
        let q = r.cells[2].querySelector('input').value || 0;
        let p = r.cells[3].querySelector('input').value || 0;
        let total = q * p;
        r.cells[4].innerText = total.toFixed(2);
        sum += total;
    });
    document.getElementById('totalDisplay').innerText = 'Total: ₹' + sum.toFixed(2);
}

async function generateBill(type) {
    const id = document.getElementById('invoiceNo').value;
    
    // Mautasim's Record
    let logs = JSON.parse(localStorage.getItem('m_records') || '[]');
    logs.push({id, name: document.getElementById('custName').value, total: document.getElementById('totalDisplay').innerText});
    localStorage.setItem('m_records', JSON.stringify(logs));

    inv++; localStorage.setItem('inv', inv);

    const pdfArea = document.getElementById('pdfWrapper');
    const c = await html2canvas(pdfArea, {
        scale: 2, 
        useCORS: true, 
        width: 794,
        windowWidth: 794 
    });
    
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    pdf.addImage(c.toDataURL('image/png'), 'PNG', 0, 0, 210, (c.height * 210) / c.width);
    
    if(type === 'download') {
        pdf.save(id + '.pdf');
    } else {
        const file = new File([pdf.output('blob')], 'Invoice.pdf', {type: 'application/pdf'});
        if(navigator.share) navigator.share({files: [file]});
    }
}

function mautasimSecret() {
    const key = prompt("Key:");
    if(key === "786") alert(localStorage.getItem('m_records'));
}
</script>
</body>
</html>
